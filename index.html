<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css" />
    <title>Wallspace</title>
</head>
<body>
    <div class="main-layout">
        <div class="column-1">
            <div class="control-panel">
                <h3>Wallspace</h3>
                <div class="form-group">
                    <label for="wallUnits">Wall Units</label>
                    <select id="wallUnits" onchange="updateWallUnits()">
                        <option value="inches">Inches</option>
                        <option value="cm">Centimeters</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="wallWidth">Wall Width (<span id="wallWidthUnit">inches</span>)</label>
                    <input type="number" id="wallWidth" value="120" min="24" max="300">
                </div>
                <div class="form-group">
                    <label for="wallHeight">Wall Height (<span id="wallHeightUnit">inches</span>)</label>
                    <input type="number" id="wallHeight" value="96" min="24" max="200">
                </div>
                <div class="form-group">
                    <label for="wallColor">Wall Color</label>
                    <input type="color" id="wallColor" value="#ffffff" class="color-input">
                </div>
                <div class="form-group">
                    <label for="wallImageUpload">Wall Background Image (optional)</label>
                    <input type="file" id="wallImageUpload" accept="image/*" onchange="handleWallImageUpload(event)">
                    <button onclick="removeWallImage()" style="margin-top: 5px; font-size: 12px; padding: 5px 10px;">Remove Image</button>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showDistanceGuides" checked onchange="toggleDistanceGuides()"> Show Distance Guides
                    </label>
                </div>
                <button onclick="updateWall()">Update Wall</button>
            </div>
        </div>

        <div class="column-3">
            <div class="workspace">
                <button class="zoom-control-btn" onclick="toggleRoomView()" title="Toggle Room View">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 11h6M11 8v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="room-perspective-wrapper" id="roomPerspective">
                    <div class="room-container" id="roomContainer">
                        <div class="room-ceiling"></div>
                        <div class="room-left-wall"></div>
                        <div class="room-right-wall"></div>
                        <div class="room-floor"></div>
                        <div class="wall-container" id="wallContainer">
                            <svg id="distanceGuidesSVG" class="distance-guides-svg"></svg>
                            <input type="file" id="fileInput" accept="image/*" multiple onchange="handleImageUpload(event)" style="display: none;">
                            <button class="wall-icon upload-icon" onclick="document.getElementById('fileInput').click()" title="Upload Images">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 19V5M12 5L5 12M12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="wall-icon save-icon" onclick="saveLayout()" title="Save Layout">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="wall-icon delete-icon" onclick="clearWall()" title="Clear Wall">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="layouts-panel" style="display: none;">
                <h3>Saved Layouts</h3>
                <div class="layout-grid" id="savedLayouts"></div>
            </div>
        </div>
    </div>

    <!-- Dialog for Selected Artwork Settings -->
    <div class="artwork-dialog" id="artworkDialog">
        <div class="dialog-content">
            <h4>Selected Artwork Settings</h4>
                <div class="control-row">
                    <div class="form-group">
                        <label for="artworkUnits">Artwork Units</label>
                        <select id="artworkUnits" onchange="updateArtworkUnits()">
                            <option value="inches">Inches</option>
                            <option value="cm">Centimeters</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="maintainRatio" checked onchange="updateArtworkSize()"> Lock Aspect Ratio
                        </label>
                    </div>
                </div>
                <div class="control-row">
                    <div class="form-group">
                        <label for="artworkWidth">Width (<span id="artworkWidthUnit">inches</span>)</label>
                        <input type="number" id="artworkWidth" step="0.1" min="1" onchange="updateArtworkSize()">
                    </div>
                    <div class="form-group">
                        <label for="artworkHeight">Height (<span id="artworkHeightUnit">inches</span>)</label>
                        <input type="number" id="artworkHeight" step="0.1" min="1" onchange="updateArtworkSize()">
                    </div>
                </div>
                <div class="control-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="hasFrame" onchange="updateSelectedArtwork()"> Add Frame
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="hasMatte" onchange="updateSelectedArtwork()"> Add Matte
                        </label>
                    </div>
                </div>
                <div class="control-row">
                    <div class="form-group">
                        <label for="frameColor">Frame Color</label>
                        <select id="frameColor" onchange="updateSelectedArtwork()">
                            <option value="#8b4513">Brown</option>
                            <option value="#000000">Black</option>
                            <option value="#ffffff">White</option>
                            <option value="#c0c0c0">Silver</option>
                            <option value="#ffd700">Gold</option>
                            <option value="#d2b48c">Birch</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="frameSize">Frame Width (<span id="frameUnit">inches</span>)</label>
                        <input type="number" id="frameSize" step="0.1" min="0.1" max="5" value="1" onchange="updateSelectedArtwork()">
                    </div>
                </div>
                <div class="control-row">
                    <div class="form-group">
                        <label for="matteColor">Matte Color</label>
                        <select id="matteColor" onchange="updateSelectedArtwork()">
                            <option value="#f5f5f5">Off-White</option>
                            <option value="#ffffff">White</option>
                            <option value="#f0f0f0">Light Gray</option>
                            <option value="#fffacd">Cream</option>
                            <option value="#000000">Black</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="matteSize">Matte Width (<span id="matteUnit">inches</span>)</label>
                        <input type="number" id="matteSize" step="0.1" min="0.1" max="5" value="1" onchange="updateSelectedArtwork()">
                    </div>
                </div>
                <button onclick="deleteSelected()">üóëÔ∏è Remove Artwork</button>
        </div>
    </div>

    <!-- Phase 1: Foundation modules -->
    <script src="js/utils.js"></script>
    <script src="js/state.js"></script>
    <!-- Phase 2: Wall module -->
    <script src="js/wall.js"></script>
    <!-- Phase 3: Artwork modules -->
    <script src="js/framing.js"></script>
    <script src="js/artwork.js"></script>

    <script>
        // Load saved layouts from localStorage
        function loadSavedLayouts() {
            try {
                const stored = localStorage.getItem('wallArtLayouts');
                savedLayouts = stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error loading layouts:', error);
                savedLayouts = [];
            }
            
            const container = document.getElementById('savedLayouts');
            container.innerHTML = '';
            
            if (savedLayouts.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; grid-column: 1/-1;">No saved layouts yet. Create your first gallery layout!</p>';
                return;
            }
            
            savedLayouts.forEach((layout, index) => {
                const layoutDiv = document.createElement('div');
                layoutDiv.className = 'layout-item';
                layoutDiv.innerHTML = `
                    <div class="layout-preview">Gallery ${index + 1}</div>
                    <p><span>${layout.name}</span></p>
                    <p style="font-size: 12px; color: #666;">${layout.artworks.length} artworks</p>
                    <p style="font-size: 11px; color: #999;">${layout.date}</p>
                    <button onclick="loadLayout(${index})" style="margin: 5px 5px 0 0;">Load</button>
                    <button onclick="deleteLayout(${index})" style="background: #e74c3c;">Delete</button>
                `;
                container.appendChild(layoutDiv);
            });
        }

        function saveLayoutsToStorage() {
            try {
                localStorage.setItem('wallArtLayouts', JSON.stringify(savedLayouts));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                alert('Unable to save layout. Your browser storage might be full.');
                return false;
            }
        }

        function positionDialog(artwork, dialog) {
            const artworkRect = artwork.getBoundingClientRect();
            const dialogWidth = 320;
            const dialogPadding = 20;

            // Try to position to the right of the artwork
            let left = artworkRect.right + dialogPadding;
            let top = artworkRect.top;

            // Check if dialog would go off screen on the right
            if (left + dialogWidth > window.innerWidth) {
                // Position to the left of the artwork
                left = artworkRect.left - dialogWidth - dialogPadding;
            }

            // If still off screen, position to the left of the artwork within the wall container
            if (left < 0) {
                left = artworkRect.left - dialogWidth - dialogPadding;
                if (left < 0) {
                    // Just position at a fixed offset if no room
                    left = artworkRect.right + 10;
                }
            }

            // Keep within vertical bounds
            const maxTop = window.innerHeight - dialog.offsetHeight - 20;
            top = Math.max(20, Math.min(top, maxTop));

            dialog.style.left = left + 'px';
            dialog.style.top = top + 'px';
        }

        function saveLayout() {
            const name = `Gallery ${savedLayouts.length + 1}`;
            const wallSettings = {
                width: document.getElementById('wallWidth').value,
                height: document.getElementById('wallHeight').value,
                color: document.getElementById('wallColor').value,
                units: document.getElementById('wallUnits').value,
                backgroundImage: wallBackgroundImage
            };
            
            const artworks = [];
            document.querySelectorAll('.artwork').forEach(artwork => {
                const style = window.getComputedStyle(artwork);
                const img = artwork.querySelector('img');
                const frame = artwork.querySelector('.frame');
                const matte = artwork.querySelector('.matte');
                
                // Get frame and matte settings
                const hasFrame = frame.style.display !== 'none' && frame.style.backgroundColor !== 'transparent';
                const hasMatte = matte.style.display !== 'none' && matte.style.backgroundColor !== 'transparent';
                
                artworks.push({
                    src: img.src,
                    left: style.left,
                    top: style.top,
                    width: style.width,
                    height: style.height,
                    hasFrame: hasFrame,
                    hasMatte: hasMatte,
                    frameColor: frame.style.backgroundColor,
                    matteColor: matte.style.backgroundColor,
                    aspectRatio: artworkAspectRatios.get(artwork.id) || 1
                });
            });
            
            const newLayout = {
                name: name,
                wallSettings: wallSettings,
                artworks: artworks,
                date: new Date().toLocaleDateString(),
                id: Date.now() // Unique ID
            };
            
            savedLayouts.push(newLayout);
            
            if (saveLayoutsToStorage()) {
                loadSavedLayouts();
                
                // Show success message
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Saved!';
                button.style.background = '#27ae60';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }
        }

        function loadLayout(index) {
            const layout = savedLayouts[index];
            
            // Set wall settings
            document.getElementById('wallWidth').value = layout.wallSettings.width;
            document.getElementById('wallHeight').value = layout.wallSettings.height;
            document.getElementById('wallColor').value = layout.wallSettings.color;
            
            // Set wall units if saved
            if (layout.wallSettings.units) {
                document.getElementById('wallUnits').value = layout.wallSettings.units;
                updateWallUnits();
            }
            
            // Set wall background image if saved
            if (layout.wallSettings.backgroundImage) {
                wallBackgroundImage = layout.wallSettings.backgroundImage;
            } else {
                wallBackgroundImage = null;
            }
            
            updateWall();
            
            // Clear existing artworks
            clearWall();
            
            // Add artworks
            layout.artworks.forEach(artworkData => {
                const wallContainer = document.getElementById('wallContainer');
                const artwork = document.createElement('div');
                artwork.className = 'artwork';
                artwork.id = 'artwork-' + (++artworkCounter);
                
                // Store aspect ratio if available
                if (artworkData.aspectRatio) {
                    artworkAspectRatios.set(artwork.id, artworkData.aspectRatio);
                }
                
                artwork.innerHTML = `
                    <div class="frame" style="display: ${artworkData.hasFrame ? 'flex' : 'none'}; background-color: ${artworkData.frameColor || 'transparent'};">
                        <div class="matte" style="display: ${artworkData.hasMatte ? 'flex' : 'none'}; background-color: ${artworkData.matteColor || 'transparent'};">
                            <div class="image-container">
                                <img src="${artworkData.src}" alt="Artwork">
                            </div>
                        </div>
                    </div>
                    <img src="${artworkData.src}" alt="Artwork" class="direct-img" style="display: ${artworkData.hasFrame || artworkData.hasMatte ? 'none' : 'block'};">
                    <div class="resize-handle"></div>
                `;
                
                artwork.style.left = artworkData.left;
                artwork.style.top = artworkData.top;
                artwork.style.width = artworkData.width;
                artwork.style.height = artworkData.height;
                
                wallContainer.appendChild(artwork);
                setupArtworkEvents(artwork);
            });
            
            // Show success message
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Loaded!';
            button.style.background = '#27ae60';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 1500);
        }

        function deleteLayout(index) {
            if (confirm(`Are you sure you want to delete "${savedLayouts[index].name}"?`)) {
                savedLayouts.splice(index, 1);
                saveLayoutsToStorage();
                loadSavedLayouts();
                
                // Show success message briefly
                const container = document.getElementById('savedLayouts');
                const message = document.createElement('div');
                message.style.cssText = 'grid-column: 1/-1; text-align: center; color: #e74c3c; font-weight: normal; padding: 10px;';
                message.textContent = 'üóëÔ∏è Layout deleted successfully';
                container.prepend(message);
                setTimeout(() => message.remove(), 2000);
            }
        }

        function clearWall() {
            if (document.querySelectorAll('.artwork').length > 0) {
                if (confirm('Are you sure you want to clear all artwork from the wall?')) {
                    document.getElementById('wallContainer').innerHTML = '';
                    selectedArtwork = null;
                    document.getElementById('artworkDialog').classList.remove('active');
                }
            }
        }

        function exportLayouts() {
            try {
                const dataStr = JSON.stringify(savedLayouts, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `wall-art-layouts-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Layouts exported successfully! You can import this file on any device.');
            } catch (error) {
                alert('‚ùå Error exporting layouts: ' + error.message);
            }
        }

        function importLayouts(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedLayouts = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedLayouts)) {
                        throw new Error('Invalid file format');
                    }
                    
                    const confirmMsg = `Import ${importedLayouts.length} layouts? This will add to your existing layouts (won't replace them).`;
                    if (confirm(confirmMsg)) {
                        // Add imported layouts to existing ones
                        savedLayouts.push(...importedLayouts);
                        saveLayoutsToStorage();
                        loadSavedLayouts();
                        alert(`‚úÖ Successfully imported ${importedLayouts.length} layouts!`);
                    }
                } catch (error) {
                    alert('‚ùå Error importing file: Invalid format or corrupted file');
                }
            };
            reader.readAsText(file);
            
            // Clear the input
            event.target.value = '';
        }

        // Global mouse events for dragging and resizing
        document.addEventListener('mousemove', function(e) {
            // Prevent all interactions in preview mode
            if (isPreviewMode) {
                isDragging = false;
                isResizing = false;
                return;
            }

            if (isDragging && selectedArtwork) {
                const wallContainer = document.getElementById('wallContainer');
                const wallRect = wallContainer.getBoundingClientRect();

                let newX = e.clientX - wallRect.left - dragOffset.x;
                let newY = e.clientY - wallRect.top - dragOffset.y;

                // Keep within bounds
                newX = Math.max(0, Math.min(newX, wallContainer.offsetWidth - selectedArtwork.offsetWidth));
                newY = Math.max(0, Math.min(newY, wallContainer.offsetHeight - selectedArtwork.offsetHeight));

                selectedArtwork.style.left = newX + 'px';
                selectedArtwork.style.top = newY + 'px';

                // Reposition dialog while dragging
                const dialog = document.getElementById('artworkDialog');
                if (dialog.classList.contains('active')) {
                    positionDialog(selectedArtwork, dialog);
                }

                // Update distance guides while dragging
                updateDistanceGuides();
            } else if (isResizing && selectedArtwork) {
                const wallContainer = document.getElementById('wallContainer');
                const wallRect = wallContainer.getBoundingClientRect();
                const artworkRect = selectedArtwork.getBoundingClientRect();

                let newWidth = e.clientX - artworkRect.left;
                let newHeight = e.clientY - artworkRect.top;

                // Maintain aspect ratio
                const aspectRatio = selectedArtwork.offsetWidth / selectedArtwork.offsetHeight;
                if (newWidth / newHeight > aspectRatio) {
                    newWidth = newHeight * aspectRatio;
                } else {
                    newHeight = newWidth / aspectRatio;
                }

                // Minimum size
                newWidth = Math.max(50, newWidth);
                newHeight = Math.max(50, newHeight);

                selectedArtwork.style.width = newWidth + 'px';
                selectedArtwork.style.height = newHeight + 'px';

                // Reposition dialog while resizing
                const dialog = document.getElementById('artworkDialog');
                if (dialog.classList.contains('active')) {
                    positionDialog(selectedArtwork, dialog);
                }

                // Update distance guides while resizing
                updateDistanceGuides();
            }
        });

        document.addEventListener('mouseup', function() {
            if (!isPreviewMode) {
                isDragging = false;
                isResizing = false;
            }
        });

        // Close dialog when clicking outside
        document.addEventListener('click', function(e) {
            // Don't process clicks in preview mode
            if (isPreviewMode) return;

            const dialog = document.getElementById('artworkDialog');
            const artwork = selectedArtwork;

            // Check if click is outside dialog and artwork
            if (dialog.classList.contains('active') &&
                !dialog.contains(e.target) &&
                (!artwork || !artwork.contains(e.target))) {
                dialog.classList.remove('active');
                if (artwork) {
                    artwork.classList.remove('selected');
                }
                selectedArtwork = null;

                // Clear distance guides when deselecting
                updateDistanceGuides();
            }
        });

        // Update wall scaling when window is resized
        window.addEventListener('resize', function() {
            updateWall();
        });

        // Room View Toggle Functions
        function toggleRoomView() {
            const roomPerspective = document.getElementById('roomPerspective');
            const roomContainer = document.getElementById('roomContainer');
            const controlPanel = document.querySelector('.column-1');
            const artworkDialog = document.getElementById('artworkDialog');

            // Toggle the zoomed class
            roomPerspective.classList.toggle('zoomed');
            roomContainer.classList.toggle('zoomed');
            isPreviewMode = !isPreviewMode;

            if (isPreviewMode) {
                // Entering preview mode - disable all editing
                controlPanel.style.pointerEvents = 'none';
                controlPanel.style.opacity = '0.5';

                // Hide and deselect artwork dialog
                artworkDialog.classList.remove('active');
                if (selectedArtwork) {
                    selectedArtwork.classList.remove('selected');
                }

                // Clear any ongoing drag/resize operations
                isDragging = false;
                isResizing = false;
            } else {
                // Exiting preview mode - re-enable all editing
                controlPanel.style.pointerEvents = 'auto';
                controlPanel.style.opacity = '1';
            }
        }

        // Distance Guides Functions
        function toggleDistanceGuides() {
            const enabled = document.getElementById('showDistanceGuides').checked;
            const svg = document.getElementById('distanceGuidesSVG');

            if (enabled && selectedArtwork) {
                updateDistanceGuides();
            } else {
                svg.innerHTML = ''; // Clear guides
            }
        }

        function updateDistanceGuides() {
            const svg = document.getElementById('distanceGuidesSVG');
            const enabled = document.getElementById('showDistanceGuides').checked;

            // Clear existing guides
            svg.innerHTML = '';

            // Only show guides if enabled and artwork is selected
            if (!enabled || !selectedArtwork) {
                return;
            }

            const wallContainer = document.getElementById('wallContainer');
            const wallWidth = wallContainer.offsetWidth;
            const wallHeight = wallContainer.offsetHeight;

            // Get artwork bounds (includes frame and matte if present)
            const artworkRect = selectedArtwork.getBoundingClientRect();
            const wallRect = wallContainer.getBoundingClientRect();

            // Calculate artwork position relative to wall
            const artworkLeft = artworkRect.left - wallRect.left;
            const artworkTop = artworkRect.top - wallRect.top;
            const artworkRight = artworkLeft + artworkRect.width;
            const artworkBottom = artworkTop + artworkRect.height;

            // Calculate center points of each side
            const centerX = artworkLeft + (artworkRect.width / 2);
            const centerY = artworkTop + (artworkRect.height / 2);
            const leftCenterX = artworkLeft;
            const leftCenterY = centerY;
            const rightCenterX = artworkRight;
            const rightCenterY = centerY;
            const topCenterX = centerX;
            const topCenterY = artworkTop;
            const bottomCenterX = centerX;
            const bottomCenterY = artworkBottom;

            // Find nearest artworks in each direction
            const otherArtworks = Array.from(document.querySelectorAll('.artwork')).filter(art => art !== selectedArtwork);
            let nearestLeft = null, nearestRight = null, nearestTop = null, nearestBottom = null;
            let nearestLeftDist = Infinity, nearestRightDist = Infinity, nearestTopDist = Infinity, nearestBottomDist = Infinity;

            otherArtworks.forEach(otherArt => {
                const otherRect = otherArt.getBoundingClientRect();
                const otherLeft = otherRect.left - wallRect.left;
                const otherTop = otherRect.top - wallRect.top;
                const otherRight = otherLeft + otherRect.width;
                const otherBottom = otherTop + otherRect.height;

                // Check if artwork is to the left (with vertical overlap)
                if (otherRight <= artworkLeft) {
                    const dist = artworkLeft - otherRight;
                    const verticalOverlap = Math.max(0, Math.min(artworkBottom, otherBottom) - Math.max(artworkTop, otherTop));
                    if (verticalOverlap > 0 && dist < nearestLeftDist) {
                        nearestLeftDist = dist;
                        nearestLeft = { otherArt, otherRect, otherLeft, otherTop, otherRight, otherBottom };
                    }
                }

                // Check if artwork is to the right (with vertical overlap)
                if (otherLeft >= artworkRight) {
                    const dist = otherLeft - artworkRight;
                    const verticalOverlap = Math.max(0, Math.min(artworkBottom, otherBottom) - Math.max(artworkTop, otherTop));
                    if (verticalOverlap > 0 && dist < nearestRightDist) {
                        nearestRightDist = dist;
                        nearestRight = { otherArt, otherRect, otherLeft, otherTop, otherRight, otherBottom };
                    }
                }

                // Check if artwork is above (with horizontal overlap)
                if (otherBottom <= artworkTop) {
                    const dist = artworkTop - otherBottom;
                    const horizontalOverlap = Math.max(0, Math.min(artworkRight, otherRight) - Math.max(artworkLeft, otherLeft));
                    if (horizontalOverlap > 0 && dist < nearestTopDist) {
                        nearestTopDist = dist;
                        nearestTop = { otherArt, otherRect, otherLeft, otherTop, otherRight, otherBottom };
                    }
                }

                // Check if artwork is below (with horizontal overlap)
                if (otherTop >= artworkBottom) {
                    const dist = otherTop - artworkBottom;
                    const horizontalOverlap = Math.max(0, Math.min(artworkRight, otherRight) - Math.max(artworkLeft, otherLeft));
                    if (horizontalOverlap > 0 && dist < nearestBottomDist) {
                        nearestBottomDist = dist;
                        nearestBottom = { otherArt, otherRect, otherLeft, otherTop, otherRight, otherBottom };
                    }
                }
            });

            // Draw guides to nearest artworks or walls
            // Left side
            if (nearestLeft) {
                const distInches = pixelsToUnits(nearestLeftDist, 'inches');
                const distCm = pixelsToUnits(nearestLeftDist, 'cm');
                const otherCenterY = nearestLeft.otherTop + (nearestLeft.otherRect.height / 2);
                const guideY = (centerY + otherCenterY) / 2; // Use midpoint of both centers
                drawGuide(svg, nearestLeft.otherRight, guideY, leftCenterX, guideY,
                         distInches, distCm, 'horizontal');
            } else if (artworkLeft > 0) {
                const distInches = pixelsToUnits(artworkLeft, 'inches');
                const distCm = pixelsToUnits(artworkLeft, 'cm');
                drawGuide(svg, 0, leftCenterY, leftCenterX, leftCenterY,
                         distInches, distCm, 'horizontal');
            }

            // Right side
            if (nearestRight) {
                const distInches = pixelsToUnits(nearestRightDist, 'inches');
                const distCm = pixelsToUnits(nearestRightDist, 'cm');
                const otherCenterY = nearestRight.otherTop + (nearestRight.otherRect.height / 2);
                const guideY = (centerY + otherCenterY) / 2;
                drawGuide(svg, rightCenterX, guideY, nearestRight.otherLeft, guideY,
                         distInches, distCm, 'horizontal');
            } else if (artworkRight < wallWidth) {
                const distInches = pixelsToUnits(wallWidth - artworkRight, 'inches');
                const distCm = pixelsToUnits(wallWidth - artworkRight, 'cm');
                drawGuide(svg, rightCenterX, rightCenterY, wallWidth, rightCenterY,
                         distInches, distCm, 'horizontal');
            }

            // Top side
            if (nearestTop) {
                const distInches = pixelsToUnits(nearestTopDist, 'inches');
                const distCm = pixelsToUnits(nearestTopDist, 'cm');
                const otherCenterX = nearestTop.otherLeft + (nearestTop.otherRect.width / 2);
                const guideX = (centerX + otherCenterX) / 2;
                drawGuide(svg, guideX, nearestTop.otherBottom, guideX, topCenterY,
                         distInches, distCm, 'vertical');
            } else if (artworkTop > 0) {
                const distInches = pixelsToUnits(artworkTop, 'inches');
                const distCm = pixelsToUnits(artworkTop, 'cm');
                drawGuide(svg, topCenterX, 0, topCenterX, topCenterY,
                         distInches, distCm, 'vertical');
            }

            // Bottom side
            if (nearestBottom) {
                const distInches = pixelsToUnits(nearestBottomDist, 'inches');
                const distCm = pixelsToUnits(nearestBottomDist, 'cm');
                const otherCenterX = nearestBottom.otherLeft + (nearestBottom.otherRect.width / 2);
                const guideX = (centerX + otherCenterX) / 2;
                drawGuide(svg, guideX, bottomCenterY, guideX, nearestBottom.otherTop,
                         distInches, distCm, 'vertical');
            } else if (artworkBottom < wallHeight) {
                const distInches = pixelsToUnits(wallHeight - artworkBottom, 'inches');
                const distCm = pixelsToUnits(wallHeight - artworkBottom, 'cm');
                drawGuide(svg, bottomCenterX, bottomCenterY, bottomCenterX, wallHeight,
                         distInches, distCm, 'vertical');
            }
        }

        function drawGuide(svg, x1, y1, x2, y2, distanceInches, distanceCm, orientation) {
            // Create line element
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            svg.appendChild(line);

            // Calculate midpoint for text label
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;

            // Format distance text (show both inches and cm)
            const distanceText = `${distanceInches.toFixed(1)}" / ${distanceCm.toFixed(1)}cm`;

            // Create text element
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', midX);
            text.setAttribute('y', midY);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.textContent = distanceText;

            // Adjust text position to avoid overlapping with line
            if (orientation === 'horizontal') {
                text.setAttribute('y', midY - 10); // Position text above the line
            } else {
                text.setAttribute('x', midX + 30); // Position text to the right of the line
            }

            svg.appendChild(text);
        }

        // Initialize
        updateWall();
        updateWallUnits();
        updateArtworkUnits();
        loadSavedLayouts();
    </script>
</body>
</html>
